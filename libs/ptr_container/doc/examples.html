<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.3.10: http://docutils.sourceforge.net/" />

<title>Boost Pointer Container Library</title><style type="text/css">

/*
:Author: David Goodger
:Contact: goodger@users.sourceforge.net
:Date: $Date: 2007-11-25 13:38:02 -0500 (Sun, 25 Nov 2007) $
:Revision: $Revision: 41370 $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* "! important" is used here to override other ``margin-top`` and
   ``margin-bottom`` styles that are later in the stylesheet or 
   more specific.  See http://www.w3.org/TR/CSS1#the-cascade */
.first {
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin-left: 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

img.borderless {
  border: 0 }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.line-block {
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em ;
  background-color: #eeeeee }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid thin gray }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid thin black }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

tt.docutils {
  background-color: #eeeeee }

ul.auto-toc {
  list-style-type: none }

</style>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" /><link rel="stylesheet" href="default.css" type="text/css" /></head>
<body>
<div class="document" id="boost-pointer-container-library">
<h1 class="title"><img alt="Boost" src="boost.png" /> Pointer Container Library 指针容器库</h1>
<h2 class="subtitle" id="examples">Examples 例子</h2>
<p>Some examples are given here and in the accompanying test files:<br />这里给出一些例子以及测试文件：</p>
<div class="contents local topic">
<ul class="simple">
<li><a class="reference" href="#null-pointers-cannot-be-stored-in-the-containers" id="id2" name="id2">1. Null pointers cannot be stored in the containers 空指针不能保存在容器中</a></li>
<li><a class="reference" href="#iterators-and-other-operations-return-indirected-values" id="id3" name="id3">2. Iterators and other operations return indirected values 迭代器和其它返回间接值的操作</a></li>
<li><a class="reference" href="#copy-semantics-of-pointer-containers" id="id4" name="id4">3. Copy-semantics of pointer containers 指针容器的复制语义</a></li>
<li><a class="reference" href="#making-a-non-copyable-type-cloneable" id="id5" name="id5">4. Making a non-copyable type Cloneable 让一个不可复制的类型可克隆</a></li>
<li><a class="reference" href="#objects-are-cloned-before-insertion-inserted-pointers-are-owned-by-the-container" id="id6" name="id6">5. Objects are cloned before insertion, inserted pointers are owned by the container 在插入之前克隆对象，被插入的指针属于容器</a></li>
<li><a class="reference" href="#transferring-ownership-of-a-single-element" id="id7" name="id7">6. Transferring ownership of a single element 转移单个元素的所有权</a></li>
<li><a class="reference" href="#transferring-ownership-of-pointers-between-different-pointer-containers" id="id8" name="id8">7. Transferring ownership of pointers between different pointer containers 在不同指针容器间转移指针的所有权</a></li>
<li><a class="reference" href="#selected-test-files" id="id9" name="id9">8. Selected test files 选定的测试文件</a></li>
<li><a class="reference" href="#a-large-example" id="id10" name="id10">9. A large example 一个较大的例子</a></li>
</ul>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id2" id="null-pointers-cannot-be-stored-in-the-containers" name="null-pointers-cannot-be-stored-in-the-containers"><span id="example-1"></span>1. Null pointers cannot be stored in the containers 空指针不能保存在容器中</a></h1>
<pre class="literal-block">my_container.push_back( 0 );            // throws bad_ptr 抛出 bad_ptr<br />my_container.replace( an_iterator, 0 ); // throws bad_ptr 抛出 bad_ptr <br />my_container.insert( an_iterator, 0 );  // throws bad_ptr 抛出 bad_ptr       <br />std::auto_ptr&lt;T&gt; p( 0 );<br />my_container.push_back( p );            // throws bad_ptr 抛出 bad_ptr                                                          </pre>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id3" id="iterators-and-other-operations-return-indirected-values" name="iterators-and-other-operations-return-indirected-values"><span id="example-2"></span>2. Iterators and other operations return indirected values 迭代器和其它返回间接值的操作</a></h1>
<pre class="literal-block">ptr_vector&lt;X&gt; pvec; <br />std::vector&lt;X*&gt; vec;<br />*vec.begin()  = new X;   // fine, memory leak 好的，内存泄漏<br />*pvec.begin() = new X;   // compile time error 编译期错误<br />( *vec.begin() )-&gt;foo(); // call X::foo(), a bit clumsy 调用 X::foo()，有点笨拙<br />pvec.begin()-&gt;foo();     // no indirection needed 不需要间接性<br />*vec.front()  = X();     // overwrite first element 覆写第一个元素<br />pvec.front()  = X();     // no indirection needed 不需要间接性<br /></pre>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id4" id="copy-semantics-of-pointer-containers" name="copy-semantics-of-pointer-containers"><span id="example-3"></span>3. Copy-semantics of pointer containers 指针容器的复制语义</a></h1>
<pre class="literal-block">ptr_vector&lt;T&gt; vec1; <br />...<br />ptr_vector&lt;T&gt; vec2( vec1.clone() ); // deep copy objects of 'vec1' and use them to construct 'vec2', could be very expensive<br />                                    // 深复制'vec1'的对象并用它们来构造'vec2'，开销可能非常高<br />vec2 = vec1.release();              // give up ownership of pointers in 'vec1' and pass the ownership to 'vec2', rather cheap<br />                                    // 放弃'vec1'中的指针的所有权并将所有权传递给'vec2'，开销较低<br />vec2.release();                     // give up ownership; the objects will be deallocated if not assigned to another container<br />                                    // 放弃所有权；其中的对象如果不赋给另一个容器就会被释放<br />vec1 = vec2;                        // deep copy objects of 'vec2' and assign them to 'vec1', could be very expensive <br />                                    // 深复制'vec2'并将它们赋值给'vec1'，开销可能非常高<br />ptr_vector&lt;T&gt; vec3( vec1 );         // deep copy objects of 'vec1', could be very expensive<br />                                    // 深复制'vec1'，开销可能非常高<br /></pre>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id5" id="making-a-non-copyable-type-cloneable" name="making-a-non-copyable-type-cloneable"><span id="example-4"></span>4. Making a non-copyable type Cloneable 让一个不可复制的类型可克隆</a></h1>
<pre class="literal-block"> // a class that has no normal copy semantics 一个没有普通复制语义的类<br />class X : boost::noncopyable { public: X* clone() const; ... };<br />                                                                   <br />// this will be found by the library by argument dependent lookup (ADL)   <br />// 以下函数可由本库通过参数相关查找(ADL)查找得到<br />X* new_clone( const X&amp; x ) <br />{ return x.clone(); }<br />                                                                   <br />// we can now use the interface that requires cloneability<br />// 现在我们可以使用需要可克隆性的接口了<br />ptr_vector&lt;X&gt; vec1, vec2;<br />...<br />vec2 = vec1.clone();                                 // 'clone()' requires cloning &lt;g&gt; <br />                                                     // 'clone()' 要求克隆<br />vec2.insert( vec2.end(), vec1.begin(), vec1.end() ); // inserting always means inserting clones<br />                                                     // 插入操作总是意味着插入克隆体&nbsp;<br /></pre>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id6" id="objects-are-cloned-before-insertion-inserted-pointers-are-owned-by-the-container" name="objects-are-cloned-before-insertion-inserted-pointers-are-owned-by-the-container"><span id="example-5"></span>5. Objects are cloned before insertion, inserted pointers are owned by the container 在插入之前克隆对象，被插入的指针属于容器</a></h1>
<pre class="literal-block">class X { ... };                     // assume 'X' is Cloneable 假设'X'是可克隆的<br />X x;                                 // and 'X' can be stack-allocated 且'X'可在栈上分配<br />ptr_list&lt;X&gt; list; <br />list.push_back( new_clone( x ) );    // insert a clone 插入一个克隆体<br />list.push_back( new X );             // always give the pointer directly to the container to avoid leaks<br />                                     // 直接将指针给容器，以避免泄漏<br />list.push_back( &amp;x );                // don't do this!!! 不要这样做!!!<br />std::auto_ptr&lt;X&gt; p( new X );<br />list.push_back( p );                 // give up ownership 放弃所有权<br />BOOST_ASSERT( p.get() == 0 );<br /></pre>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id7" id="transferring-ownership-of-a-single-element" name="transferring-ownership-of-a-single-element"><span id="example-6"></span>6. Transferring ownership of a single element 转移单个元素的所有权</a></h1>
<pre class="literal-block">ptr_deque&lt;T&gt;                    deq; <br />typedef ptr_deque&lt;T&gt;::auto_type auto_type;<br /><br />// ... fill the container somehow ...以某种方式填充容器<br /><br />auto_type ptr  = deq.release_back();             // remove back element from container and give up ownership<br />                                                 // 从容器中删除最后一个元素并放弃所有权<br />auto_type ptr2 = deq.release( deq.begin() + 2 ); // use an iterator to determine the element to release<br />                                                 // 用一个迭代器来决定被释放的元素<br />ptr            = deq.release_front();            // supported for 'ptr_list' and 'ptr_deque'<br />                                                 // 支持 'ptr_list' 和 'ptr_deque'                                <br />deq.push_back( ptr.release() );                  // give ownership back to the container<br />                                                 // 将所有权给回容器<br /></pre>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id8" id="transferring-ownership-of-pointers-between-different-pointer-containers" name="transferring-ownership-of-pointers-between-different-pointer-containers"><span id="example-7"></span>7. Transferring ownership of pointers between different pointer containers 在不同指针容器间转移指针的所有权</a></h1>
<pre class="literal-block">ptr_list&lt;X&gt; list; ptr_vector&lt;X&gt; vec;<br />...<br />//<br />// note: no cloning happens in these examples<br />// 注意：在这些例子中没有发生克隆&nbsp;<br />//<br />list.transfer( list.begin(), vec.begin(), vec );           // make the first element of 'vec' the first element of 'list'<br />                                                           // 将'vec'的首元素变为'list’的首元素<br />vec.transfer( vec.end(), list.begin(), list.end(), list ); // put all the lists element into the vector     <br />                                                           // 将list中的所有元素放入vector中<br /></pre>
<p>We can also transfer objects from <tt class="docutils literal"><span class="pre">ptr_container&lt;Derived&gt;</span></tt> to <tt class="docutils literal"><span class="pre">ptr_container&lt;Base&gt;</span></tt> without any problems.<br />我们也可以将对象从 <tt class="docutils literal"><span class="pre">ptr_container&lt;Derived&gt;</span></tt> 转移到 <tt class="docutils literal"><span class="pre">ptr_container&lt;Base&gt;</span></tt> 中，没有任何问题。</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id9" id="selected-test-files" name="selected-test-files"><span id="example-8"></span>8. Selected test files 选定的测试文件</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name" colspan="2"><a class="reference" href="../test/incomplete_type_test.cpp">incomplete_type_test.cpp</a>:</th></tr>
<tr><td>&nbsp;</td><td class="field-body">Shows how to implement the Composite pattern.<br />示范如何实现组合模式</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><a class="reference" href="../test/simple_test.cpp">simple_test.cpp</a>:</th></tr>
<tr><td>&nbsp;</td><td class="field-body">Shows how the usage of pointer container compares with a 
container of smart pointers<br />示范指针容器用法与智能指针容器用法的比较</td>
</tr>
<tr class="field"><th class="field-name" colspan="2"><a class="reference" href="../test/view_example.cpp">view_example.cpp</a>:</th></tr>
<tr><td>&nbsp;</td><td class="field-body">Shows how to use a pointer container as a view into other container<br />示范如何将指针容器用作另一个容器的视图</td>
</tr>
<tr class="field"><th class="field-name"><a class="reference" href="../test/tree_test.cpp">tree_test.cpp</a>:</th><td class="field-body">Shows how to make a tree-structure<br />示范如何构建一个树型结构</td>
</tr>
<tr class="field"><th class="field-name"><a class="reference" href="../test/ptr_array.cpp">array_test.cpp</a>:</th><td class="field-body">Shows how to make an n-ary tree<br />示范如何构建一个n叉树</td>
</tr>
</tbody>
</table>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id10" id="a-large-example" name="a-large-example">9. A large example 一个较大的例子</a></h1>
<p>This examples shows many of the most common
features at work. The example provide lots of comments.<br />这个例子示范了多种在实际工作中最常用的特性。该例子提供了大量注释。</p>






    <pre><span class="comment">//<br />// Boost.Pointer Container<br />//<br />//  Copyright Thorsten Ottosen 2003-2005. Use, modification and<br />//  distribution is subject to the Boost Software License, Version<br />//  1.0. (See accompanying file LICENSE_1_0.txt or copy at<br />//  http://www.boost.org/LICENSE_1_0.txt)<br />//<br />// For more information, see http://www.boost.org/libs/ptr_container/<br />// </span><span class="comment">更多信息，请见 http://www.boost.org/libs/ptr_container/</span><span class="comment"> <br /><br />//<br />// This example is intended to get you started.<br />// 这个例子的意图是让你入门。<br />// Notice how the smart container<br />// 留意这个智能容器如何：<br />// 1. takes ownership of objects 接管对象的所有权<br />// 2. transfers ownership 转移所有权<br />// 3. applies indirection to iterators 对迭代器应用间接性<br />// 4. clones objects from other smart containers 从另一个智能容器克隆对象<br />// <br /><br />//<br />// First we select which container to use.<br />// 首先我们选择使用哪一种容器</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">ptr_container</span><span class="special">/</span><span class="identifier">ptr_deque</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="comment">//<br />// we need these later in the example<br />// 在本例中，稍后我们将需要它们</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">assert</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">exception</span><span class="special">&gt;</span>


<span class="comment">//<br />// Then we define a small polymorphic class<br />// hierarchy.<br />// 然后我们定义一个小的多态类的层次。</span> <br /><br /><span class="keyword">class</span> <span class="identifier">animal</span> <span class="special">:</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">noncopyable</span>
<span class="special">{</span>
    <span class="keyword">virtual</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">do_speak</span><span class="special">()</span> <span class="keyword">const</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">name_</span><span class="special">;</span>

<span class="keyword">protected</span><span class="special">:</span>
    <span class="comment">//<br />    // Animals cannot be copied...<br />    // 动物不能被复制...</span>
    <span class="identifier">animal</span><span class="special">(</span> <span class="keyword">const</span> <span class="identifier">animal</span><span class="special">&amp;</span> <span class="identifier">r</span> <span class="special">)</span> <span class="special">:</span> <span class="identifier">name_</span><span class="special">(</span> <span class="identifier">r</span><span class="special">.</span><span class="identifier">name_</span> <span class="special">)</span>           <span class="special">{</span> <span class="special">}</span>
    <span class="keyword">void</span> <span class="keyword">operator</span><span class="special">=(</span> <span class="keyword">const</span> <span class="identifier">animal</span><span class="special">&amp;</span> <span class="special">);</span>

<span class="keyword">private</span><span class="special">:</span>
    <span class="comment">//<br />    // ...but due to advances in genetics, we can clone them!<br />    // ...但由于遗传学的发展，我们可以克隆它们！</span>

    <span class="keyword">virtual</span> <span class="identifier">animal</span><span class="special">*</span> <span class="identifier">do_clone</span><span class="special">()</span> <span class="keyword">const</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>
        
<span class="keyword">public</span><span class="special">:</span>
    <span class="identifier">animal</span><span class="special">(</span> <span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&amp;</span> <span class="identifier">name</span> <span class="special">)</span> <span class="special">:</span> <span class="identifier">name_</span><span class="special">(</span><span class="identifier">name</span><span class="special">)</span>        <span class="special">{</span> <span class="special">}</span>
    <span class="keyword">virtual</span> <span class="special">~</span><span class="identifier">animal</span><span class="special">()</span> <span class="keyword">throw</span><span class="special">()</span>                              <span class="special">{</span> <span class="special">}</span>
    
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">speak</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">do_speak</span><span class="special">();</span>
    <span class="special">}</span>

    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">name</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">name_</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="identifier">animal</span><span class="special">*</span> <span class="identifier">clone</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">do_clone</span><span class="special">();</span>
    <span class="special">}</span>
<span class="special">};</span>

<span class="comment">//<br />// An animal is still not Clonable. We need this last hook.<br />// 一个动物仍不可克隆。我们需要这个函数。<br />// Notice that we pass the animal by const reference<br />// and return by pointer.<br />// 注意我们通过常量引用来传递 animal，并通过指针返回</span>

<span class="identifier">animal</span><span class="special">*</span> <span class="identifier">new_clone</span><span class="special">(</span> <span class="keyword">const</span> <span class="identifier">animal</span><span class="special">&amp;</span> <span class="identifier">a</span> <span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">a</span><span class="special">.</span><span class="identifier">clone</span><span class="special">();</span>
<span class="special">}</span>

<span class="comment">//<br />// We do not need to define 'delete_clone()' since<br />// since the default is to call the default 'operator delete()'.<br />// 我们不需要定义'delete_clone()'，因为缺省是调用缺省的'operator delete()'。</span>

<span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">muuuh</span> <span class="special">=</span> <span class="string">"Muuuh!"</span><span class="special">;</span>
<span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">oiink</span> <span class="special">=</span> <span class="string">"Oiiink"</span><span class="special">;</span>

<span class="keyword">class</span> <span class="identifier">cow</span> <span class="special">:</span> <span class="keyword">public</span> <span class="identifier">animal</span>
<span class="special">{</span>
    <span class="keyword">virtual</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">do_speak</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">muuuh</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="keyword">virtual</span> <span class="identifier">animal</span><span class="special">*</span> <span class="identifier">do_clone</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="identifier">cow</span><span class="special">(</span> <span class="special">*</span><span class="keyword">this</span> <span class="special">);</span>
    <span class="special">}</span>

<span class="keyword">public</span><span class="special">:</span>
    <span class="identifier">cow</span><span class="special">(</span> <span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&amp;</span> <span class="identifier">name</span> <span class="special">)</span> <span class="special">:</span> <span class="identifier">animal</span><span class="special">(</span><span class="identifier">name</span><span class="special">)</span>          <span class="special">{</span> <span class="special">}</span>
<span class="special">};</span>

<span class="keyword">class</span> <span class="identifier">pig</span> <span class="special">:</span> <span class="keyword">public</span> <span class="identifier">animal</span>
<span class="special">{</span>
    <span class="keyword">virtual</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">do_speak</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">oiink</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="keyword">virtual</span> <span class="identifier">animal</span><span class="special">*</span> <span class="identifier">do_clone</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="identifier">pig</span><span class="special">(</span> <span class="special">*</span><span class="keyword">this</span> <span class="special">);</span>
    <span class="special">}</span>
    
<span class="keyword">public</span><span class="special">:</span>
    <span class="identifier">pig</span><span class="special">(</span> <span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&amp;</span> <span class="identifier">name</span> <span class="special">)</span> <span class="special">:</span> <span class="identifier">animal</span><span class="special">(</span><span class="identifier">name</span><span class="special">)</span>          <span class="special">{</span> <span class="special">}</span>
<span class="special">};</span>

<span class="comment">//<br />// Then we, of course, need a place to put all<br />// those animals.<br />// 当然，我们需要一个地方来放置所有的动物。</span>

<span class="keyword">class</span> <span class="identifier">farm</span>
<span class="special">{</span>
    <span class="comment">//<br />    // This is where the smart containers are handy<br />    // 这就是要用的智能容器</span>
    <span class="keyword">typedef</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">ptr_deque</span><span class="special">&lt;</span><span class="identifier">animal</span><span class="special">&gt;</span> <span class="identifier">barn_type</span><span class="special">;</span>
    <span class="identifier">barn_type</span>                        <span class="identifier">barn</span><span class="special">;</span>

    <span class="comment">//<br />    // An error type<br />    // 一个错误类型</span>
    <span class="keyword">struct</span> <span class="identifier">farm_trouble</span> <span class="special">:</span> <span class="keyword">public</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">exception</span>           <span class="special">{</span> <span class="special">};</span>

<span class="keyword">public</span><span class="special">:</span>
    <span class="comment">// <br />    // We would like to make it possible to<br />    // iterate over the animals in the farm<br />    // 我们要可以在农场中遍历动物</span>
    <span class="keyword">typedef</span> <span class="identifier">barn_type</span><span class="special">::</span><span class="identifier">iterator</span>  <span class="identifier">animal_iterator</span><span class="special">;</span>

    <span class="comment">//<br />    // We also need to count the farm's size...<br />    // 我们也要计算农场的大小...</span>
    <span class="keyword">typedef</span> <span class="identifier">barn_type</span><span class="special">::</span><span class="identifier">size_type</span> <span class="identifier">size_type</span><span class="special">;</span>
    
    <span class="comment">//<br />    // And we also want to transfer an animal<br />    // safely around. The easiest way to think<br />    // about '::auto_type' is to imagine a simplified<br />    // 'std::auto_ptr&lt;T&gt;' ... this means you can expect<br />    // 我们还要安全地转移一个动物。想象'::auto_type'的最容易的方法<br />    // 是当作'std::auto_ptr&lt;T&gt;' ... 这意味着你可以用<br />    //<br />    //   T* operator-&gt;()<br />    //   T* release()<br />    //   deleting destructor<br />    //<br />    // but not more.<br />    // 但没有其它了。</span>
    <span class="keyword">typedef</span> <span class="identifier">barn_type</span><span class="special">::</span><span class="identifier">auto_type</span>  <span class="identifier">animal_transport</span><span class="special">;</span>

    <span class="comment">// <br />    // Create an empty farm.<br />    // 创建一个空的农场。</span>
    <span class="identifier">farm</span><span class="special">()</span>                                                 <span class="special">{</span> <span class="special">}</span>
    
    <span class="comment">//<br />    // We need a constructor that can make a new<br />    // farm by cloning a range of animals.<br />    // 我们需要一个构造函数，它可以通过克隆一个动物区间来构建新农场。</span>
    <span class="identifier">farm</span><span class="special">(</span> <span class="identifier">animal_iterator</span> <span class="identifier">begin</span><span class="special">,</span> <span class="identifier">animal_iterator</span> <span class="identifier">end</span> <span class="special">)</span>
     <span class="special">:</span> <br />        <span class="comment">//<br />        // Objects are always cloned before insertion<br />        // unless we explicitly add a pointer or <br />        // use 'release()'. Therefore we actually<br />        // clone all animals in the range<br />        // 对象在插入之前总是被克隆，除非我们显式加入一个指针或<br />        // 使用'release()'。因此我们要克隆区间中的所有动物</span>
        <span class="identifier">barn</span><span class="special">(</span> <span class="identifier">begin</span><span class="special">,</span> <span class="identifier">end</span> <span class="special">)</span>                               <span class="special">{</span> <span class="special">}</span>
    
    <span class="comment">//<br />    // ... so we need some other function too<br />    // ... 我们还需要其它一些函数</span>

    <span class="identifier">animal_iterator</span> <span class="identifier">begin</span><span class="special">()</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">barn</span><span class="special">.</span><span class="identifier">begin</span><span class="special">();</span>
    <span class="special">}</span>

    <span class="identifier">animal_iterator</span> <span class="identifier">end</span><span class="special">()</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">barn</span><span class="special">.</span><span class="identifier">end</span><span class="special">();</span>
    <span class="special">}</span>
    
    <span class="comment">//<br />    // Here it is quite ok to have an 'animal*' argument.<br />    // The smart container will handle all ownership<br />    // issues.<br />    // 这里使用一个'animal*'参数当然是可以的。智能容器将处理所有权的问题。</span>
    <span class="keyword">void</span> <span class="identifier">buy_animal</span><span class="special">(</span> <span class="identifier">animal</span><span class="special">*</span> <span class="identifier">a</span> <span class="special">)</span>
    <span class="special">{</span>
        <span class="identifier">barn</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span> <span class="identifier">a</span> <span class="special">);</span>
    <span class="special">}</span>

    <span class="comment">//<br />    // The farm can also be in economical trouble and<br />    // therefore be in the need to sell animals.<br />    // 农场还可能由于经济问题而需要卖掉动物。</span>
    <span class="identifier">animal_transport</span> <span class="identifier">sell_animal</span><span class="special">(</span> <span class="identifier">animal_iterator</span> <span class="identifier">to_sell</span> <span class="special">)</span>
    <span class="special">{</span>
        <span class="keyword">if</span><span class="special">(</span> <span class="identifier">to_sell</span> <span class="special">==</span> <span class="identifier">end</span><span class="special">()</span> <span class="special">)</span>
            <span class="keyword">throw</span> <span class="identifier">farm_trouble</span><span class="special">();</span>

        <span class="comment">//<br />        // Here we remove the animal from the barn,<br />        // but the animal is not deleted yet...it's<br />        // up to the buyer to decide what<br />        // to do with it.<br />        // 这里我们从 barn 移除动物，但动物并没有被删除...<br />        // 由购买者决定怎么处理。<br /></span>       &nbsp;<span class="keyword">return</span> <span class="identifier">barn</span><span class="special">.</span><span class="identifier">release</span><span class="special">(</span> <span class="identifier">to_sell</span> <span class="special">);</span>
    <span class="special">}</span>

    <span class="comment">//<br />    // How big a farm do we have?<br />    // 我们的家声有多大？</span>
    <span class="identifier">size_type</span> <span class="identifier">size</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">barn</span><span class="special">.</span><span class="identifier">size</span><span class="special">();</span>
    <span class="special">}</span>

    <span class="comment">//<br />    // If things are bad, we might choose to sell all animals :-(<br />    // 如果情况变坏，我们可能要选择卖掉所有动物 :-(</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">auto_ptr</span><span class="special">&lt;</span><span class="identifier">barn_type</span><span class="special">&gt;</span> <span class="identifier">sell_farm</span><span class="special">()</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">barn</span><span class="special">.</span><span class="identifier">release</span><span class="special">();</span>
    <span class="special">}</span>

    <span class="comment">//<br />    // However, if things are good, we might buy somebody<br />    // else's farm :-)<br />    // 不过，如果情况变好，我们可以买入其它农场 :-)</span>

    <span class="keyword">void</span> <span class="identifier">buy_farm</span><span class="special">(</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">auto_ptr</span><span class="special">&lt;</span><span class="identifier">barn_type</span><span class="special">&gt;</span> <span class="identifier">other</span> <span class="special">)</span>
    <span class="special">{</span>
        <span class="comment">//<br />        // This line inserts all the animals from 'other'<br />        // and is guaranteed either to succeed or to have no<br />        // effect<br />        // 这一行代码插入来自'other'的所有动物，并保证要么成功要么没有发生变化</span>
        <span class="identifier">barn</span><span class="special">.</span><span class="identifier">transfer</span><span class="special">(</span> <span class="identifier">barn</span><span class="special">.</span><span class="identifier">end</span><span class="special">(),</span> <span class="comment">// insert new animals at the end 在末尾插入新动物</span>
                         <span class="special">*</span><span class="identifier">other</span> <span class="special">);</span>     <span class="comment">// we want to transfer all animals,<br />                                       // so we use the whole container as argument<br />                                       // 我们想转移所有的动物，所以我们用整个容器作为参数<br />        //<br />        // You might think you would have to do<br />        // 你可能想，需要调用<br />        // other.release();<br />        //<br />        // but '*other' is empty and can go out of scope as it wants<br />        // 但由于'*other'已为空，可以按它的需要离开此作用域</span>
        <span class="identifier">BOOST_ASSERT</span><span class="special">(</span> <span class="identifier">other</span><span class="special">-&gt;</span><span class="identifier">empty</span><span class="special">()</span> <span class="special">);</span>
    <span class="special">}</span>
    
<span class="special">};</span> <span class="comment">// class 'farm'.</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">()</span>
<span class="special">{</span>
    <span class="comment">//<br />    // First we make a farm<br />    // 首先我们创建一个农场</span>
    <span class="identifier">farm</span> <span class="identifier">animal_farm</span><span class="special">;</span>
    <span class="identifier">BOOST_ASSERT</span><span class="special">(</span> <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">size</span><span class="special">()</span> <span class="special">==</span> <span class="number">0u</span> <span class="special">);</span>
    
    <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">buy_animal</span><span class="special">(</span> <span class="keyword">new</span> <span class="identifier">pig</span><span class="special">(</span><span class="string">"Betty"</span><span class="special">)</span> <span class="special">);</span>
    <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">buy_animal</span><span class="special">(</span> <span class="keyword">new</span> <span class="identifier">pig</span><span class="special">(</span><span class="string">"Benny"</span><span class="special">)</span> <span class="special">);</span>
    <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">buy_animal</span><span class="special">(</span> <span class="keyword">new</span> <span class="identifier">pig</span><span class="special">(</span><span class="string">"Jeltzin"</span><span class="special">)</span> <span class="special">);</span>
    <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">buy_animal</span><span class="special">(</span> <span class="keyword">new</span> <span class="identifier">cow</span><span class="special">(</span><span class="string">"Hanz"</span><span class="special">)</span> <span class="special">);</span>
    <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">buy_animal</span><span class="special">(</span> <span class="keyword">new</span> <span class="identifier">cow</span><span class="special">(</span><span class="string">"Mary"</span><span class="special">)</span> <span class="special">);</span>
    <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">buy_animal</span><span class="special">(</span> <span class="keyword">new</span> <span class="identifier">cow</span><span class="special">(</span><span class="string">"Frederik"</span><span class="special">)</span> <span class="special">);</span>
    <span class="identifier">BOOST_ASSERT</span><span class="special">(</span> <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">size</span><span class="special">()</span> <span class="special">==</span> <span class="number">6u</span> <span class="special">);</span>

    <span class="comment">//<br />    // Then we make another farm...it will actually contain<br />    // a clone of the other farm.<br />    // 然后我们创建另一个农场...它其实包含了前一个农场的克隆。</span>
    <span class="identifier">farm</span> <span class="identifier">new_farm</span><span class="special">(</span> <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">end</span><span class="special">()</span> <span class="special">);</span>
    <span class="identifier">BOOST_ASSERT</span><span class="special">(</span> <span class="identifier">new_farm</span><span class="special">.</span><span class="identifier">size</span><span class="special">()</span> <span class="special">==</span> <span class="number">6u</span> <span class="special">);</span>

    <span class="comment">//<br />    // Is it really clones in the new farm?<br />    // 在新农场中真的是克隆体吗？</span>
    <span class="identifier">BOOST_ASSERT</span><span class="special">(</span> <span class="identifier">new_farm</span><span class="special">.</span><span class="identifier">begin</span><span class="special">()-&gt;</span><span class="identifier">name</span><span class="special">()</span> <span class="special">==</span> <span class="string">"Betty"</span> <span class="special">);</span>
    
    <span class="comment">//<br />    // Then we search for an animal, Mary (the Crown Princess of Denmark),<br />    // because we would like to buy her ...<br />    // 然后我们查找一个动物，Mary(丹麦的皇太子妃)，因为我们想买入她...</span>
    <span class="keyword">typedef</span> <span class="identifier">farm</span><span class="special">::</span><span class="identifier">animal_iterator</span> <span class="identifier">iterator</span><span class="special">;</span>
    <span class="identifier">iterator</span> <span class="identifier">to_sell</span><span class="special">;</span>
    <span class="keyword">for</span><span class="special">(</span> <span class="identifier">iterator</span> <span class="identifier">i</span>   <span class="special">=</span> <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span>
                  <span class="identifier">end</span> <span class="special">=</span> <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">end</span><span class="special">();</span>
         <span class="identifier">i</span> <span class="special">!=</span> <span class="identifier">end</span><span class="special">;</span> <span class="special">++</span><span class="identifier">i</span> <span class="special">)</span>
    <span class="special">{</span>
        <span class="keyword">if</span><span class="special">(</span> <span class="identifier">i</span><span class="special">-&gt;</span><span class="identifier">name</span><span class="special">()</span> <span class="special">==</span> <span class="string">"Mary"</span> <span class="special">)</span>
        <span class="special">{</span>
            <span class="identifier">to_sell</span> <span class="special">=</span> <span class="identifier">i</span><span class="special">;</span>
            <span class="keyword">break</span><span class="special">;</span>
        <span class="special">}</span>
    <span class="special">}</span>

    <span class="identifier">farm</span><span class="special">::</span><span class="identifier">animal_transport</span> <span class="identifier">mary</span> <span class="special">=</span> <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">sell_animal</span><span class="special">(</span> <span class="identifier">to_sell</span> <span class="special">);</span>


    <span class="keyword">if</span><span class="special">(</span> <span class="identifier">mary</span><span class="special">-&gt;</span><span class="identifier">speak</span><span class="special">()</span> <span class="special">==</span> <span class="identifier">muuuh</span> <span class="special">)</span>
        <span class="comment">//<br />        // Great, Mary is a cow, and she may live longer<br />        // 好的，Mary是一只母牛，她可以活得更长一点</span>
        <span class="identifier">new_farm</span><span class="special">.</span><span class="identifier">buy_animal</span><span class="special">(</span> <span class="identifier">mary</span><span class="special">.</span><span class="identifier">release</span><span class="special">()</span> <span class="special">);</span>
    <span class="keyword">else</span>
        <span class="comment">//<br />        // Then the animal would be destroyed (!)<br />        // when we go out of scope.<br />        // 然后该动物将在我们离开此作用域时被销毁(!)</span>
        <span class="special">;</span>

    <span class="comment">//<br />    // Now we can observe some changes to the two farms...<br />    // 现在我们可以观察两个农场的变化...</span>
    <span class="identifier">BOOST_ASSERT</span><span class="special">(</span> <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">size</span><span class="special">()</span> <span class="special">==</span> <span class="number">5u</span> <span class="special">);</span>
    <span class="identifier">BOOST_ASSERT</span><span class="special">(</span> <span class="identifier">new_farm</span><span class="special">.</span><span class="identifier">size</span><span class="special">()</span>    <span class="special">==</span> <span class="number">7u</span> <span class="special">);</span>

    <span class="comment">//<br />    // The new farm has however underestimated how much<br />    // it cost to feed Mary and its owner is forced to sell the farm...<br />    // 不过新农场低估了喂养Mary的花销，农场主被迫卖掉了农场...</span>
    <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">buy_farm</span><span class="special">(</span> <span class="identifier">new_farm</span><span class="special">.</span><span class="identifier">sell_farm</span><span class="special">()</span> <span class="special">);</span>

    <span class="identifier">BOOST_ASSERT</span><span class="special">(</span> <span class="identifier">new_farm</span><span class="special">.</span><span class="identifier">size</span><span class="special">()</span>    <span class="special">==</span> <span class="number">0u</span> <span class="special">);</span>
    <span class="identifier">BOOST_ASSERT</span><span class="special">(</span> <span class="identifier">animal_farm</span><span class="special">.</span><span class="identifier">size</span><span class="special">()</span> <span class="special">==</span> <span class="number">12u</span> <span class="special">);</span>     <br /><span class="special">}</span>
</pre>
<!-- 10. Changing the Clone Allocator
++++++++++++++++++++++++++++++++

This example shows how we can change 
the Clone Allocator to use the pointer containers
as view into other containers:

.. raw:: html
        :file: tut2.html -->
<hr /><p><strong>Navigate: 导读：</strong></p>
<ul class="simple">
<li><a class="reference" href="ptr_container.html">home 主页</a></li>
<li><a class="reference" href="reference.html">reference 参考</a></li>
</ul>
<hr /><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Copyright:</th><td class="field-body">Thorsten Ottosen 2004-2006. Use, modification and distribution is subject to the Boost Software License, Version 1.0 (see <a class="reference" href="http://www.boost.org/LICENSE_1_0.txt">LICENSE_1_0.txt</a>).</td>
</tr>
</tbody>
</table>
</div>
</div>
</body></html>