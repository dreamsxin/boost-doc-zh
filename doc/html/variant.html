<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>




  
  
  
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">





  
  
  
  
  
  
  <title>Chapter 21. Boost.Variant</title>
  <link rel="stylesheet" href="boostbook.css" type="text/css">




  
  
  
  <meta name="generator" content="DocBook XSL Stylesheets V1.68.1">




  
  
  
  <link rel="start" href="index.html" title="The Boost C++ Libraries BoostBook Documentation Subset">




  
  
  
  <link rel="up" href="libraries.html" title="Part&nbsp;I.&nbsp;The Boost C++ Libraries (BoostBook Subset)">




  
  
  
  <link rel="prev" href="typeof/ackn.html" title=" Acknowledgements">




  
  
  
  <link rel="next" href="variant/tutorial.html" title="Tutorial">
</head>


<body alink="#0000ff" bgcolor="white" link="#0000ff" text="black" vlink="#840084">




<table cellpadding="2" width="100%">




  <tbody>



    <tr>



      <td valign="top"><img alt="Boost C++ Libraries" src="../../boost.png" height="86" width="277"></td>




      <td align="center"><a href="../../index.htm">Home</a></td>




      <td align="center"><a href="../../libs/libraries.htm">Libraries</a></td>




      <td align="center"><a href="../../people/people.htm">People</a></td>




      <td align="center"><a href="../../more/faq.htm">FAQ</a></td>




      <td align="center"><a href="../../more/index.htm">More</a></td>




    </tr>



  
  
  
  </tbody>
</table>




<hr>
<div class="spirit-nav">
<a accesskey="p" href="typeof/ackn.html"><img src="images/prev.png" alt="Prev"></a><a accesskey="u" href="libraries.html"><img src="images/up.png" alt="Up"></a><a accesskey="h" href="index.html"><img src="images/home.png" alt="Home"></a><a accesskey="n" href="variant/tutorial.html"><img src="images/next.png" alt="Next"></a>
</div>




<div class="chapter" lang="en">
<div class="titlepage">
<div>
<div>
<h2 class="title">
<a name="variant"></a>Chapter&nbsp;21.&nbsp;Boost.Variant</h2>



</div>




<div>
<div class="author">
<h3 class="author">
<span class="firstname">Eric</span> <span class="surname">Friedman</span>
</h3>



</div>



</div>




<div>
<div class="author">
<h3 class="author">
<span class="firstname">Itay</span> <span class="surname">Maman</span>
</h3>



</div>



</div>




<div>
<p class="copyright">Copyright &copy; 2002, 2003 Eric Friedman, Itay Maman</p>



</div>




<div>
<div class="legalnotice">
<a name="id1940572"></a>
<p>Permission to copy, use, sell and distribute this software
    is granted provided this copyright notice appears in all copies.
    Permission to modify the code and to distribute modified code is
    granted provided this copyright notice appears in all copies, and
    a notice that the code was modified is included with the copyright
    notice.</p>




<p> This software is provided "as is" without express or
    implied warranty, and with no claim as to its suitability for any
    purpose.</p>




</div>



</div>




</div>



</div>




<div class="toc">
<p><b>目录</b></p>




<dl>




  <dt><span class="section"><a href="variant.html#variant.intro">简介</a></span></dt>




  <dd>
    
    
    
    <dl>




      <dt><span class="section"><a href="variant.html#variant.abstract">概要</a></span></dt>




      <dt><span class="section"><a href="variant.html#variant.motivation">动机</a></span></dt>




    
    
    
    </dl>



  </dd>




  <dt><span class="section"><a href="variant/tutorial.html">指南</a></span></dt>




  <dd>
    
    
    
    <dl>




      <dt><span class="section"><a href="variant/tutorial.html#variant.tutorial.basic">基本用法</a></span></dt>




      <dt><span class="section"><a href="variant/tutorial.html#variant.tutorial.advanced">高级议题</a></span></dt>




    
    
    
    </dl>



  </dd>




  <dt><span class="section"><a href="variant/reference.html">参考</a></span></dt>




  <dd>
    
    
    
    <dl>




      <dt><span class="section"><a href="variant/reference.html#variant.concepts">概念</a></span></dt>




      <dt><span class="section"><a href="variant/reference.html#header.boost.variant.hpp">头文件 &lt;boost/variant.hpp&gt;</a></span></dt>




      <dt><span class="section"><a href="variant/reference.html#header.boost.variant.variant_fwd.hpp">头文件 &lt;boost/variant/variant_fwd.hpp&gt;</a></span></dt>




      <dt><span class="section"><a href="variant/reference.html#header.boost.variant.variant.hpp">头文件 &lt;boost/variant/variant.hpp&gt;</a></span></dt>




      <dt><span class="section"><a href="variant/reference.html#header.boost.variant.recursive_variant.hpp">头文件 &lt;boost/variant/recursive_variant.hpp&gt;</a></span></dt>




      <dt><span class="section"><a href="variant/reference.html#header.boost.variant.recursive_wrapper.hpp">头文件 &lt;boost/variant/recursive_wrapper.hpp&gt;</a></span></dt>




      <dt><span class="section"><a href="variant/reference.html#header.boost.variant.apply_visitor.hpp">头文件 &lt;boost/variant/apply_visitor.hpp&gt;</a></span></dt>




      <dt><span class="section"><a href="variant/reference.html#header.boost.variant.get.hpp">头文件 &lt;boost/variant/get.hpp&gt;</a></span></dt>




      <dt><span class="section"><a href="variant/reference.html#header.boost.variant.bad_visit.hpp">头文件 &lt;boost/variant/bad_visit.hpp&gt;</a></span></dt>




      <dt><span class="section"><a href="variant/reference.html#header.boost.variant.static_visitor.hpp">头文件 &lt;boost/variant/static_visitor.hpp&gt;</a></span></dt>




      <dt><span class="section"><a href="variant/reference.html#header.boost.variant.visitor_ptr.hpp">头文件 &lt;boost/variant/visitor_ptr.hpp&gt;</a></span></dt>




    
    
    
    </dl>



  </dd>




  <dt><span class="section"><a href="variant/design.html">设计概览</a></span></dt>




  <dd>
    
    
    
    <dl>



      <dt><span class="section"><a href="variant/design.html#variant.design.never-empty">"非空" 保证</a></span></dt>



    
    
    
    </dl>



  </dd>




  <dt><span class="section"><a href="variant/misc.html">杂项说明</a></span></dt>




  <dd>
    
    
    
    <dl>




      <dt><span class="section"><a href="variant/misc.html#variant.versus-any">Boost.Variant 与 Boost.Any</a></span></dt>




      <dt><span class="section"><a href="variant/misc.html#id1952714">可移植性</a></span></dt>




      <dt><span class="section"><a href="variant/misc.html#variant.troubleshooting">疑难解答</a></span></dt>




      <dt><span class="section"><a href="variant/misc.html#variant.ack">鸣谢</a></span></dt>




    
    
    
    </dl>



  </dd>




  <dt><span class="section"><a href="variant/refs.html">参考书目</a></span></dt>




</dl>




</div>




<div class="section" lang="en">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both;">
<a name="variant.intro"></a>简介</h2>



</div>



</div>



</div>




<div class="toc">
<dl>




  <dt><span class="section"><a href="variant.html#variant.abstract">概要</a></span></dt>




  <dt><span class="section"><a href="variant.html#variant.motivation">动机</a></span></dt>




</dl>



</div>




<div class="section" lang="en">
<div class="titlepage">
<div>
<div>
<h3 class="title">
<a name="variant.abstract"></a>概要</h3>



</div>



</div>



</div>




<p><code class="computeroutput">variant</code> 类模板是一个安全的、泛型的、基于栈的、可识别的联合容器，为以统一风格操作异类类型集合的对象提供了一个简单的方法。象 <code class="computeroutput">std::vector</code> 这样的标准容器可以被视为
"<span class="bold"><strong>多值，单一类型</strong></span>"，而 <code class="computeroutput">variant</code> 则是 "<span class="bold"><strong>多类型，单值</strong></span>"。</p>




<p><code class="computeroutput"><a href="boost/variant.html" title="Class template variant">boost::variant</a></code>
的主要特性包括：</p>




<div class="itemizedlist">
<ul type="disc">




  <li>完全的值语义，包括遵守转换操作符的标准重载决议规则。</li>




  <li>经由
    <code class="computeroutput"><a href="boost/apply_visitor.html" title="Function apply_visitor">boost::apply_visitor</a></code> 的编译期类型安全的值访问。</li>




  <li>经由
    <code class="computeroutput"><a href="boost/get.html" title="Function get">boost::get</a></code> 的运行期带检查的显式的值取出。</li>




  <li>通过
    <code class="computeroutput"><a href="boost/make_recursive_variant.html" title="Class template make_recursive_variant">boost::make_recursive_variant</a></code> 和
    <code class="computeroutput"><a href="boost/recursive_wrapper.html" title="Class template recursive_wrapper">boost::recursive_wrapper</a></code> 支持递归的 variant 类型。</li>




  <li>高效的实现 -- 尽可能基于栈(详情请见
    <a href="variant/design.html#variant.design.never-empty" title="&quot;Never-Empty&quot; Guarantee">&ldquo;"非空" 保证&rdquo; 一节</a>)。</li>




</ul>



</div>




</div>




<div class="section" lang="en">
<div class="titlepage">
<div>
<div>
<h3 class="title">
<a name="variant.motivation"></a>动机</h3>



</div>



</div>



</div>




<div class="toc">
<dl>




  <dt><span class="section"><a href="variant.html#variant.motivation.problem">问题</a></span></dt>




  <dt><span class="section"><a href="variant.html#variant.motivation.solution">解决方法：一个例子</a></span></dt>




</dl>



</div>




<div class="section" lang="en">
<div class="titlepage">
<div>
<div>
<h4 class="title">
<a name="variant.motivation.problem"></a>问题</h4>



</div>



</div>



</div>




<p>很多时候，在开发一个C++程序时，程序员会发现需要以统一的风格来操作多个不同的类型。确实，C++以 <code class="computeroutput">union</code> 
关键字直接提供了这种支持：</p>




<pre class="programlisting">union { int i; double d; } u;<br>u.d = 3.14;<br>u.i = 3; // 覆写 u.d (OK: u.d 是一个 POD 类型)</pre>




<p>但是，C++的 <code class="computeroutput">union</code> 结构在面向对象的环境下几乎是不可用的。该结构得以保存下来，主要是为了与C兼容，它只能支持 POD (Plain Old Data) 类型，不可以使用带有非平凡构造或析构的类型：</p>




<pre class="programlisting">union {<br>  int i;<br>  std::string s; // 非法: std::string 不是一个 POD 类型!<br>} u;</pre>




<p>显然，我们需要另一种方法。典型的方法是对对象进行动态分配，随之而来就是要通过一个公共基类(通常是一个虚基类[<a href="variant/refs.html#variant.refs.hen01">Hen01</a>]
或者是更危险的 <code class="computeroutput">void*</code>)来进行操作。然后通过一个多态的向下转型结构(如 <code class="computeroutput">dynamic_cast</code>,
<code class="computeroutput"><a href="boost/any_cast.html" title="Function any_cast">boost::any_cast</a></code>, 等等)来取回具体类型的对象。</p>




<p>但是，这类方法是非常容易出错的，因为以下原因：</p>




<div class="itemizedlist">
<ul type="disc">




  <li>
    <span class="emphasis"><em>向下转型的错误不能在编译期被检测到。</em></span>因此，对向下转型结构的错误使用将导致只能在运行期被检查出来的 bug。</li>




  <li>
    <span class="emphasis"><em>新加入的具体类可能被忽略。</em></span>如果一个新的具体类被加入到类层次中，已有的向下转型代码可以继续工作，完全忽略掉了新的类型。因此，程序员必须手工定位和修改多处代码，这通常会导致运行期错误且难以觉察。</li>




</ul>



</div>




<p>此外，即使被正确地实现，这类方法还是会由于使用了堆、虚拟函数调用和多态向下转型而导致相对严重的开销。</p>




</div>




<div class="section" lang="en">
<div class="titlepage">
<div>
<div>
<h4 class="title">
<a name="variant.motivation.solution"></a>解决方法：一个例子</h4>



</div>



</div>



</div>




<p><code class="computeroutput"><a href="boost/variant.html" title="Class template variant">boost::variant</a></code> 类模板以安全、简单和高效的方法解决了这个问题。以下例子示范了如何使用这个类：</p>




<pre class="programlisting">#include "boost/variant.hpp"<br>#include &lt;iostream&gt;<br><br>class my_visitor : public <code class="computeroutput"><a href="boost/static_visitor.html" title="Class template static_visitor">boost::static_visitor</a></code>&lt;int&gt;<br>{<br>public:<br>    int operator()(int i) const<br>    {<br>        return i;<br>    }<br>    <br>    int operator()(const <code class="computeroutput">std::string</code> &amp; str) const<br>    {<br>        return str.length();<br>    }<br>};<br><br>int main()<br>{<br>    <code class="computeroutput"><a href="boost/variant.html" title="Class template variant">boost::variant</a></code>&lt; int, std::string &gt; u("hello world");<br>    std::cout &lt;&lt; u; // output: hello world<br><br>    int result = <code class="computeroutput"><a href="boost/apply_visitor.html" title="Function apply_visitor">boost::apply_visitor</a></code>( my_visitor(), u );<br>    std::cout &lt;&lt; result; // output: 11 (i.e., length of "hello world")<br>}<br></pre>




</div>




</div>




</div>




</div>




<table width="100%">



  <tbody>



    <tr>




      <td align="left"></td>




      <td align="right"><small></small></td>




    </tr>



  
  
  
  </tbody>
</table>




<hr>
<div class="spirit-nav">
<a accesskey="p" href="typeof/ackn.html"><img src="images/prev.png" alt="Prev"></a><a accesskey="u" href="libraries.html"><img src="images/up.png" alt="Up"></a><a accesskey="h" href="index.html"><img src="images/home.png" alt="Home"></a><a accesskey="n" href="variant/tutorial.html"><img src="images/next.png" alt="Next"></a>
</div>




</body>
</html>
