<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0.1 Transitional//EN">
<html>
<head>


  
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">



  
  
  <title>Boost.Flyweight Documentation - Tutorial - Technical issues</title>
  <link rel="stylesheet" href="../style.css" type="text/css">


  
  <link rel="start" href="../index.html">


  
  <link rel="prev" href="extension.html">


  
  <link rel="up" href="index.html">


  
  <link rel="next" href="lambda_expressions.html">
</head>


<body>


<h1><img src="../../../../boost.png" alt="Boost logo" align="middle" height="86" width="277">Boost.Flyweight Tutorial: Technical issues</h1>



<div class="prev_link"><a href="extension.html"><img src="../prev.gif" alt="extending Boost.Flyweight" border="0"><br>


Extending Boost.Flyweight
</a></div>


<div class="up_link"><a href="index.html"><img src="../up.gif" alt="Boost.Flyweight tutorial" border="0"><br>


Boost.Flyweight tutorial
</a></div>


<div class="next_link"><a href="lambda_expressions.html"><img src="../next.gif" alt="annex: MPL lambda expressions" border="0"><br>


Annex: MPL lambda expressions
</a></div>

<br style="" clear="all">



<hr>

<h2>Contents &nbsp;&#30446;&#24405;</h2>



<ul>


  <li><a href="#static_init">Static data initialization &nbsp;&#38745;&#24577;&#25968;&#25454;&#21021;&#22987;&#21270;</a></li>


</ul>



<h2><a name="static_init">Static data initialization &nbsp;&#38745;&#24577;&#25968;&#25454;&#21021;&#22987;&#21270;</a></h2>



<p>
For any given <code>T</code>, the type <code>flyweight&lt;T&gt;</code>
maintains some class-wide or static data that needs to be properly
initialized before the class can be used. The internal machinery of
Boost.Flyweight guarantees that static data initialization
takes place automatically before the first use of the particular
<code>flyweight&lt;T&gt;</code> instantiation in the program, and in
any case always during the so-called <i>dynamic initialization phase</i>
of the program startup sequence. Although this is not strictly
required by the C++ standard, in current practice dynamic initialization
is completed before <code>main()</code> begins.</p>

<p>&#23545;&#20219;&#20309;&#32473;&#23450;&#30340;<code><big>T</big>&#65292;</code><big><code>flyweight&lt;T&gt;</code></big>&#31867;&#22411;&#32500;&#25252;&#30528;&#19968;&#20123;&#31867;&#32423;&#21035;&#30340;&#25110;&#32773;&#38745;&#24577;&#25968;&#25454;&#65292;&#36825;&#20123;&#25968;&#25454;&#22312;&#31867;&#21487;&#20197;&#34987;&#20351;&#29992;&#20043;&#21069;&#38656;&#35201;&#34987;&#24688;&#24403;&#30340;&#21021;&#22987;&#21270;&#12290;Boost.Flyweight&#30340;&#20869;&#37096;&#26426;&#21046;&#20445;&#35777;&#65306;&#31243;&#24207;&#20013;&#26576;&#20010;<big><code>flyweight&lt;T&gt;</code></big>&#30340;&#23454;&#20363;&#39318;&#27425;&#20351;&#29992;&#20043;&#21069;&#38745;&#24577;&#25968;&#25454;&#30340;&#21021;&#22987;&#21270;&#20250;&#33258;&#21160;&#36827;&#34892;&#65292;&#32780;&#19988;&#26080;&#35770;&#22914;&#20309;&#24635;&#26159;&#22312;&#31243;&#24207;&#21551;&#21160;&#39034;&#24207;&#20013;&#25152;&#35859;&#30340;<span style="font-style: italic;">&#21160;&#24577;&#21021;&#22987;&#21270;&#38454;&#27573;</span>&#36827;&#34892;&#12290;&#34429;&#28982;C++&#26631;&#20934;&#27809;&#20005;&#26684;&#35201;&#27714;&#65292;&#20294;&#26159;&#30446;&#21069;&#30340;&#20570;&#27861;&#26159;&#21160;&#24577;&#21021;&#22987;&#21270;&#26159;&#22312;<big><code>main()</code></big>&#24320;&#22987;&#21069;&#23601;&#23436;&#25104;&#20102;&#12290;
</p>



<p>
So, for all practical purposes, static data initialization is performed
before <code>main()</code> or before the first pre-<code>main()</code>
usage of the class, for instance if we declare a global
<code>static flyweight&lt;T&gt;</code> object. This covers the vast
majority of usage cases in a transparent manner, but there are
some scenarios where the automatic static data initialization
policy of Boost.Flyweight can fail:</p>

<p>&#22240;&#27492;&#65292;&#23454;&#38469;&#19978;&#65292;&#38745;&#24577;&#25968;&#25454;&#21021;&#22987;&#21270;&#26159;&#22312;<big><code>main()</code></big>&#20043;&#21069;&#25191;&#34892;&#25110;&#32773;<big><code>main()</code></big>&#20043;&#21069;&#31532;&#19968;&#27425;&#20351;&#29992;&#36825;&#20010;&#31867;&#20043;&#21069;&#25191;&#34892;&#30340;&#65292;&#20363;&#22914;&#22914;&#26524;&#25105;&#20204;&#23450;&#20041;&#19968;&#20010;&#20840;&#23616;&#38745;&#24577;&#30340;<big><code>static flyweight&lt;T&gt;</code></big>&#23545;&#35937;&#12290; &#36825;&#20197;&#19968;&#31181;&#36879;&#26126;&#30340;&#26041;&#24335;&#35206;&#30422;&#20102;&#32477;&#22823;&#22810;&#25968;&#30340;&#20351;&#29992;&#24773;&#20917;&#65292;&#20294;&#26159;&#23384;&#22312;&#19968;&#20123;&#22330;&#21512;Boost.Flyweight&#30340;&#33258;&#21160;&#38745;&#24577;&#25968;&#25454;&#21021;&#22987;&#21270;&#31574;&#30053;&#20250;&#22833;&#36133;&#65306;
</p>



<blockquote>
  
  <pre><span class="comment">// global thread pool</span>

<span class="keyword">class</span> <span class="identifier">thread_pool</span>
<span class="special">{</span>
<span class="keyword">public</span><span class="special">:</span>
  <span class="identifier">thread_pool</span><span class="special">()</span>
  <span class="special">{</span>
    <span class="keyword">for</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span><span class="special">=</span><span class="number">0</span><span class="special">;</span><span class="identifier">i</span><span class="special">&lt;</span><span class="number">100</span><span class="special">;++</span><span class="identifier">i</span><span class="special">)</span><span class="identifier">p</span><span class="special">[</span><span class="identifier">i</span><span class="special">]=</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">thread</span><span class="special">&gt;(</span><span class="keyword">new</span> <span class="identifier">thread</span><span class="special">(</span><span class="identifier">thread_fun</span><span class="special">));</span>
  <span class="special">}</span>

<span class="keyword">private</span><span class="special">:</span>
  <span class="keyword">static</span> <span class="keyword">void</span> <span class="identifier">thread_fun</span><span class="special">()</span>
  <span class="special">{</span>
    <span class="comment">// uses flyweight&lt;std::string&gt;</span>
  <span class="special">}</span>
  <span class="identifier">array</span><span class="special">&lt;</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">thread</span><span class="special">&gt;,</span><span class="number">100</span><span class="special">&gt;</span> <span class="identifier">p</span><span class="special">;</span>
<span class="special">};</span>

<span class="keyword">static</span> <span class="identifier">thread_pool</span> <span class="identifier">thpool</span><span class="special">;</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">()</span>
<span class="special">{</span>
  <span class="special">...</span></pre>

</blockquote>



<p>
The global pool of the example launches several threads, each of which
internally uses <code>flyweight&lt;std::string&gt;</code>.
Static data initialization can potentially be executed twice concurrently
if two threads happen to collide on the first usage of
<code>flyweight&lt;std::string&gt;</code>: Boost.Flyweight initialization
does not consider thread safety. So, we need to explicitly take care of
static data initialization in a thread safe context before launching
the threads:</p>

<p>&#36825;&#20010;&#20363;&#23376;&#20013;&#30340;&#20840;&#23616;&#30340;&#32447;&#31243;&#27744;&#21551;&#21160;&#20102;&#33509;&#24178;&#32447;&#31243;&#65292;&#27599;&#20010;&#32447;&#31243;&#20869;&#37096;&#37117;&#20250;&#20351;&#29992;<code><big>flyweight&lt;std::string&gt;</big></code>&#12290;&#38745;&#24577;&#25968;&#25454;&#21021;&#22987;&#21270;&#26377;&#21487;&#33021;&#24182;&#21457;&#25191;&#34892;2&#27425;&#65292;&#22914;&#26524;2&#20010;&#32447;&#31243;&#37117;&#24688;&#22909;&#31532;&#19968;&#27425;&#20351;&#29992;<code><big>flyweight&lt;std::string&gt;</big>&#65306;</code>Boost.Flyweight&#30340;&#21021;&#22987;&#21270;&#27809;&#26377;&#32771;&#34385;&#32447;&#31243;&#23433;&#20840;&#12290;&#22240;&#27492;&#65292;&#22312;&#21551;&#21160;&#36825;&#20123;&#32447;&#31243;&#20043;&#21069;&#65292;&#25105;&#20204;&#24517;&#39035;&#22312;&#19968;&#20010;&#32447;&#31243;&#23433;&#20840;&#30340;&#29615;&#22659;&#19979;&#26174;&#31034;&#30340;&#22788;&#29702;&#22909;&#38745;&#24577;&#25968;&#25454;&#21021;&#22987;&#21270; &#12290;
</p>



<blockquote>
  
  <pre><span class="keyword">class</span> <span class="identifier">thread_pool</span>
<span class="special">{</span>
<span class="keyword">public</span><span class="special">:</span>
  <span class="identifier">thread_pool</span><span class="special">()</span>
  <span class="special">{</span>
    <b><span class="identifier">flyweight</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&gt;::</span><span class="identifier">init</span><span class="special">();</span></b>
    <span class="keyword">for</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span><span class="special">=</span><span class="number">0</span><span class="special">;</span><span class="identifier">i</span><span class="special">&lt;</span><span class="number">100</span><span class="special">;++</span><span class="identifier">i</span><span class="special">)</span><span class="identifier">p</span><span class="special">[</span><span class="identifier">i</span><span class="special">]=</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">thread</span><span class="special">&gt;(</span><span class="keyword">new</span> <span class="identifier">thread</span><span class="special">(</span><span class="identifier">thread_fun</span><span class="special">));</span>
  <span class="special">}</span>
  <span class="special">...</span></pre>

</blockquote>



<p>
The static member function <code>init</code> is not thread safe, either: in our particular
example it just happens to be called in a single threaded environment.
When concurrency can happen, <code>flyweight&lt;T&gt;::init</code> must
be properly synchronized by the programmer by using some mutual exclusion
mechanisms of her own.</p>

<p>&#21516;&#26679;&#65292;&#38745;&#24577;&#25104;&#21592;&#20989;&#25968;<big><code>init</code></big>&#20989;&#20063;&#19981;&#26159;&#32447;&#31243;&#23433;&#20840;&#30340;&#65306;&#22312;&#25105;&#20204;&#36825;&#20010;&#20855;&#20307;&#20363;&#23376;&#37324;&#23427;&#24688;&#22909;&#26159;&#22312;&#19968;&#20010;&#21333;&#32447;&#31243;&#30340;&#29615;&#22659;&#37324;&#34987;&#35843;&#29992;&#30340;&#12290; &#24403;&#26377;&#21487;&#33021;&#20986;&#29616;&#24182;&#21457;&#30340;&#26102;&#20505;&#65292;&#31243;&#24207;&#21592;&#24517;&#39035;&#33258;&#24049;&#20351;&#29992;&#19968;&#20123;&#20114;&#26021;&#26426;&#21046;&#26469;&#24688;&#24403;&#30340;&#21516;&#27493;<big><code>flyweight&lt;T&gt;::init</code></big>&#30340;&#35843;&#29992;&#12290;
</p>



<p>
The following is another example where the default static initialization
provided by Boost.Flyweight can fail:</p>

<p>&#25509;&#19979;&#26469;&#26159;Boost.Flyweight&#30340;&#40664;&#35748;&#38745;&#24577;&#21021;&#22987;&#21270;&#20250;&#22833;&#36133;&#30340;&#21478;&#19968;&#20010;&#20363;&#23376;&#65306;
</p>



<blockquote>
  
  <pre><span class="keyword">static</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">flyweight</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&gt;</span> <span class="special">&gt;</span> <span class="identifier">v</span><span class="special">;</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">()</span>
<span class="special">{</span>
  <span class="comment">// use v</span>
<span class="special">}</span></pre>

</blockquote>



<p>
In some environments, the program above fails at termination time with something
like the following:</p>

<p>&#22312;&#26576;&#20123;&#29615;&#22659;&#19979;&#65292;&#19978;&#38754;&#30340;&#31243;&#24207;&#22312;&#32467;&#26463;&#26102;&#20250;&#36755;&#20986;&#20687;&#19979;&#38754;&#36825;&#26679;&#30340;&#38169;&#35823;&#20449;&#24687;&#65306;
</p>



<blockquote>
  
  <pre>Assertion failed: count()==0, file c:\boost\flyweight\refcounted.hpp, line 55<br></pre>

</blockquote>



<p>
What is the problem? Although the type of <code>v</code> involves
<code>flyweight&lt;std::string&gt;</code>, constructing <code>v</code> as an empty vector
need not create any flyweight object proper; so,
it is perfectly possible that the static initialization of
<code>flyweight&lt;std::string&gt;</code> happens <i>after</i> the construction
of <code>v</code>; when this is the case, the static destruction of
the associated factory will occur <i>before</i> <code>v</code>'s
destruction, leaving the vector with dangling flyweights.
Again, the solution consists in explicitly forcing the static instantiation
of <code>flyweight&lt;std::string&gt;</code> before <code>v</code> is
created. Here, calling
the function <code>flyweight&lt;std::string&gt;::init</code> is a little
cumbersome, so we can resort to the utility type
<code>flyweight&lt;std::string&gt;::initializer</code> to do that job for us:</p>

<p>&#20986;&#20160;&#20040;&#38382;&#39064;&#20102;&#65311;&#34429;&#28982;<big><code>v</code></big>&#30340;&#31867;&#22411;&#31867;&#29992;&#21040;&#20102;<code><big>flyweight&lt;std::string&gt;</big>&#65292;</code>&#20294;&#26159;&#26500;&#36896;&#19968;&#20010;&#31354;&#30340;&#21521;&#37327;<big><code>v</code></big>&#19981;&#38656;&#35201;&#21019;&#24314;&#20219;&#20309;flyweight&#23545;&#35937;&#26412;&#36523;&#65307;&#20110;&#26159;&#65292;&#23436;&#20840;&#26377;&#21487;&#33021;<big><code>flyweight&lt;std::string&gt;</code></big>&#30340;&#38745;&#24577;&#21021;&#22987;&#21270;&#21457;&#29983;&#22312;<big><code>v</code></big>&#30340;&#26500;&#36896;<span style="font-style: italic;">&#20043;&#21518;</span>&#65307;&#24403;&#20986;&#29616;&#36825;&#31181;&#24773;&#20917;&#26102;&#65292;&#30456;&#20851;&#24037;&#21378;&#30340;&#38745;&#24577;&#26512;&#26500;&#23558;&#22312;<big><code>v</code></big>&#30340;&#26512;&#26500;<span style="font-style: italic;">&#20043;&#21069;</span>&#21457;&#29983;&#65292;&#20351;&#24471;&#21521;&#37327;&#37324;&#23613;&#26159;&#20123;&#24748;&#25346;&#30340;flyweight&#12290;&#21516;&#26679;&#30340;&#65292;&#35299;&#20915;&#21150;&#27861;&#26159;&#26174;&#31034;&#24378;&#21046;<big><code>flyweight&lt;std::string&gt;</code></big>&#30340;&#38745;&#24577;&#21021;&#22987;&#21270;&#22312;<big><code>v</code></big>&#21019;&#24314;&#20043;&#21069;&#12290;&#36825;&#37324;&#65292;&#35843;&#29992;&#20989;&#25968;<big><code>flyweight&lt;std::string&gt;::init</code></big>&#26377;&#28857;&#40635;&#28902;&#65292;&#22240;&#27492;&#25105;&#20204;&#27714;&#21161;&#20110;&#24037;&#20855;&#31867;<big><code>flyweight&lt;std::string&gt;::initializer</code></big>&#26367;&#25105;&#20204;&#20570;&#36825;&#20010;&#24037;&#20316;&#12290;
</p>



<blockquote>
  
  <pre><span class="comment">// equivalent to calling flyweight&lt;std::string&gt;::init()</span>
<b><span class="keyword">static</span> <span class="identifier">flyweight</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&gt;::</span><span class="identifier">initializer</span>  <span class="identifier">fwinit</span><span class="special">;</span></b>
<span class="keyword">static</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">flyweight</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&gt;</span> <span class="special">&gt;</span> <span class="identifier">v</span><span class="special">;</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">()</span>
<span class="special">{</span>
  <span class="comment">// use v; no dangling flyweights at termination now</span>
<span class="special">}</span></pre>

</blockquote>



<hr>

<div class="prev_link"><a href="extension.html"><img src="../prev.gif" alt="extending Boost.Flyweight" border="0"><br>


Extending Boost.Flyweight
</a></div>


<div class="up_link"><a href="index.html"><img src="../up.gif" alt="Boost.Flyweight tutorial" border="0"><br>


Boost.Flyweight tutorial
</a></div>


<div class="next_link"><a href="lambda_expressions.html"><img src="../next.gif" alt="annex: MPL lambda expressions" border="0"><br>


Annex: MPL lambda expressions
</a></div>

<br style="" clear="all">



<br>



<p>Revised August 11th 2008</p>



<p>&copy; Copyright 2006-2008 Joaqu&iacute;n M L&oacute;pez Mu&ntilde;oz.
Distributed under the Boost Software 
License, Version 1.0. (See accompanying file <a href="../../../../LICENSE_1_0.txt">
LICENSE_1_0.txt</a> or copy at <a href="http://www.boost.org/LICENSE_1_0.txt">
http://www.boost.org/LICENSE_1_0.txt</a>)
</p>



</body>
</html>
